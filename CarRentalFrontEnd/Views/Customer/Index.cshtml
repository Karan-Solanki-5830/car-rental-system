@model List<CarRentalFrontEnd.Models.CustomerModel>

<div class="dashboard-card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="card-title">@(ViewData["PageTitle"])</h2>
    </div>

    <div class="card-body p-4">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-3 p-3 mb-4">
                <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-3 p-3 mb-4">
                <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            </div>
        }

        <form id="customer-search-form" class="row g-3 mb-3" onsubmit="searchCustomers(); return false;">
            <div class="col-md-4">
                <input type="text" class="form-control" id="name" name="name" placeholder="Search by name">
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" id="email" name="email" placeholder="Search by email">
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" id="phone" name="phone" placeholder="Search by phone">
            </div>
            <div class="col-md-2 d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-fill"><i class="fas fa-search"></i></button>
                <button type="button" id="customer-clear-filters" class="btn btn-outline-danger border-2 rounded-pill px-3 shadow-sm flex-fill fw-semibold" onclick="clearFilters()" title="Clear filters">
                    <i class="fas fa-times me-1"></i> Clear
                </button>
            </div>
        </form>
        <script>
            function searchCustomers() {
                const name = $('#name').val();
                const email = $('#email').val();
                const phone = $('#phone').val();
                
                $.ajax({
                    url: '/Customer/Search',
                    type: 'GET',
                    data: { name, email, phone },
                    beforeSend: function() {
                        $('#customer-table-body').html('<tr><td colspan="3" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>');
                    },
                    success: function(data) {
                        $('#customer-table-body').html(data);
                    },
                    error: function() {
                        $('#customer-table-body').html('<tr><td colspan="3" class="text-center text-danger">Error loading customers. Please try again.</td></tr>');
                    }
                });
            }

            function clearFilters() {
                $('#name, #email, #phone').val('');
                searchCustomers();
            }

            // Search as you type with debounce
            let searchTimer;
            $('#name, #email, #phone').on('input', function() {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(searchCustomers, 500);
            });
        </script>

        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                    </tr>
                </thead>
                <tbody id="customer-table-body">
                    @Html.Partial("_CustomerTable", Model)
                </tbody>
                <tfoot id="search-status" class="d-none">
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status" id="loading-indicator" style="display: none;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div id="no-results-message" class="text-muted" style="display: none;">
                                <i class="fas fa-search me-2"></i>No customers found matching your search criteria.
                            </div>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Pagination Controls -->
        <nav>
            <ul class="pagination justify-content-center mt-4">
                @if (ViewBag.TotalPages != null && ViewBag.TotalPages > 1)
                {
                    int currentPage = ViewBag.CurrentPage ?? 1;
                    int totalPages = ViewBag.TotalPages;
                    for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = i })">@i</a>
                        </li>
                    }
                }
            </ul>
        </nav>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // Handle search form submission
            $('#customer-search-form').on('submit', function (e) {
                e.preventDefault();
                var query = $(this).serialize();
                $('#loading-indicator').show();
                $.get(`/Customer/Search?${query}`, function (data) {
                    $('#customer-table-body').html(data);
                }).always(function(){
                    $('#loading-indicator').hide();
                });
            });

            // Clear filters
            $('#customer-clear-filters').on('click', function(){
                const form = $('#customer-search-form')[0];
                form.reset();
                $('#customer-search-form').trigger('submit');
            });
        });
    </script>
}
