<style>
    .popular-vehicles-list .vehicle-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #444;
    }

    .popular-vehicles-list .vehicle-item:last-child {
        border-bottom: none;
    }

    .popular-vehicles-list .vehicle-name {
        font-size: 1.1rem;
        color: #ffffff;
        font-weight: 500;
    }

    .popular-vehicles-list .booking-count {
        font-size: 1.0rem;
        color: #00d4aa;
        font-weight: 500;
    }
</style>

<div class="dashboard-content">
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label"><i class="fas fa-users"></i> Users</div>
            <div class="stat-value" id="userCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label"><i class="fas fa-user-friends"></i> Customers</div>
            <div class="stat-value" id="customerCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label"><i class="fas fa-car"></i> Vehicles</div>
            <div class="stat-value" id="vehicleCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label"><i class="fas fa-file-contract"></i> Bookings</div>
            <div class="stat-value" id="bookingCount">0</div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Monthly Revenue -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">Monthly Revenue</h3>
                <i class="fas fa-ellipsis-h card-menu"></i>
            </div>
            <div class="chart-container">
                <canvas id="monthlyRevenueChart"></canvas>
            </div>
        </div>

        <!-- Vehicle Availability (Pie) -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">Vehicle Availability</h3>
                <i class="fas fa-ellipsis-h card-menu"></i>
            </div>
            <div class="chart-container">
                <canvas id="vehicleAvailabilityChart"></canvas>
            </div>
        </div>

        <!-- Popular Vehicles -->
        <div class="dashboard-card popular-vehicles-card">
            <div class="card-header">
                <h3 class="card-title">Most Popular Vehicles</h3>
                <i class="fas fa-ellipsis-h card-menu"></i>
            </div>
            <div class="popular-vehicles-list" id="popularVehiclesList">
                <!-- Loaded via AJAX -->
            </div>
        </div>
    </div>

    <!-- Recent Bookings Table -->
    <div class="dashboard-card bookings-table">
        <div class="card-header">
            <h3 class="card-title">Recent Bookings</h3>
            <a class="btn btn-outline" href="@Url.Action("Index", "Booking")">View All Bookings</a>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Booking Id</th>
                    <th>Customer Id</th>
                    <th>Vehicle Id</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="recentBookingsTableBody">
                <!-- Loaded via AJAX -->
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('/Home/GetDashboardData')
                .then(response => response.json())
                .then(data => {
                    // 1. Update KPIs
                    animateCount('userCount', data.userCount);
                    animateCount('customerCount', data.customerCount);
                    animateCount('vehicleCount', data.vehicleCount);
                    animateCount('bookingCount', data.bookingCount);

                    // 2. Render Charts
                    renderMonthlyRevenueChart(data.monthlyRevenue);
                    renderVehicleAvailabilityChart(data.availableVehicles, data.unavailableVehicles);

                    // 3. Populate Lists and Tables
                    populatePopularVehicles(data.popularVehicles);
                    populateRecentBookings(data.recentBookings);
                })
                .catch(error => console.error('Error fetching dashboard data:', error));
        });

        function animateCount(id, target) {
            const el = document.getElementById(id);
            if (!el) return;
            const duration = 1200;
            const step = Math.ceil(target / (duration / 16));
            let current = 0;
            function update() {
                current += step;
                if (current >= target) {
                    el.textContent = target;
                } else {
                    el.textContent = current;
                    requestAnimationFrame(update);
                }
            }
            update();
        }

        function renderMonthlyRevenueChart(revenueData) {
            const revenueLabels = Object.keys(revenueData);
            const revenueValues = Object.values(revenueData);
            const revenueCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: revenueLabels,
                    datasets: [{
                        label: 'Revenue',
                        data: revenueValues,
                        borderColor: '#00d4aa',
                        backgroundColor: 'rgba(0, 212, 170, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#fff' } },
                        x: { ticks: { color: '#fff' } }
                    }
                }
            });
        }

        function renderVehicleAvailabilityChart(available, unavailable) {
            const vaCtx = document.getElementById('vehicleAvailabilityChart').getContext('2d');
            new Chart(vaCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Unavailable'],
                    datasets: [{
                        data: [available, unavailable],
                        backgroundColor: ['#00d4aa', '#ff4757'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
        }

        function populatePopularVehicles(vehicles) {
            const list = document.getElementById('popularVehiclesList');
            if (!list) return;
            list.innerHTML = '';
            if (vehicles && vehicles.length > 0) {
                vehicles.forEach(item => {
                    const vehicle = item.Vehicle || item.vehicle || {};
                    const count = item.Count || item.count || 0;
                    const modelName = vehicle.model || vehicle.Model;
                    if (modelName) {
                        list.innerHTML += `
                            <div class="vehicle-item">
                                <span class="vehicle-name">${modelName}</span>
                                <span class="booking-count">${count} booking${count !== 1 ? 's' : ''}</span>
                            </div>`;
                    }
                });
            } else {
                list.innerHTML = '<p>No popular vehicle data available.</p>';
            }
        }

        function populateRecentBookings(bookings) {
            const tbody = document.getElementById('recentBookingsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (bookings && bookings.length > 0) {
                bookings.forEach(booking => {
                    const startDate = new Date(booking.startDateTime).toLocaleDateString();
                    const endDate = new Date(booking.endDateTime).toLocaleDateString();
                    tbody.innerHTML += `
                        <tr>
                            <td>${booking.bookingId}</td>
                            <td>${booking.customerId}</td>
                            <td>${booking.vehicleId}</td>
                            <td>${startDate}</td>
                            <td>${endDate}</td>
                            <td>${booking.status}</td>
                        </tr>`;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No recent bookings found.</td></tr>';
            }
        }
    </script>
}